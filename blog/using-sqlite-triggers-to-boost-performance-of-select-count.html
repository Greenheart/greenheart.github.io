<!doctype html>
<html lang="en" class="dark">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/images/favicon.svg" type="image/svg+xml" />
        <link rel="icon" href="/images/favicon-32x32.png" type="image/png" />
        <link rel="icon" href="/favicon.ico" />
        <meta name="theme-color" content="#5ac75f" />
        <meta name="color-scheme" content="dark light" />
        <script>
            document.documentElement.classList.toggle(
                'dark',
                localStorage.theme === 'dark' ||
                    (!('theme' in localStorage) &&
                        window.matchMedia('(prefers-color-scheme: dark)')
                            .matches),
            )
        </script>
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/images/compass-icon-square.svg"
        />
        <link
            href="/feed.json"
            type="application/feed+json"
            rel="alternate"
            title="Blog feed (JSON)"
        />
        <link
            href="/feed.atom"
            type="application/atom+xml"
            rel="alternate"
            title="Blog feed (Atom)"
        />
        
		<link href="../_app/immutable/assets/0.488w5Sjj.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.VKf-84Bf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cua82Kfv.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CJ5kycIc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CzssVKiR.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.Dtaxfko_.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/X3pk7U9o.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bdha1fzv.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BGW--rBo.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/U57kl7hy.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BIxsqi5k.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/f7323myC.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BdUv-eYE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CLaDNB_m.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BC9GrCcg.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/I_XotMi0.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D1lv_vzg.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/LulF463E.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/h-MAvg0y.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DvVQtHu_.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cx6Rq4FS.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/5.BVAJzEqq.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CGtxOdJw.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Bn4XHSUF.js"><!--12qhfyh--><meta name="fediverse:creator" content="@Greenheart@fosstodon.org"/><!----><!--hu6oa8--><!--[--><!--]--> <!--[--><meta name="robots" content="index,follow"/><!--]--> <!--[--><meta name="description" content="Experienced fullstack developer, curious about how tech, systems thinking and Doughnut design for business can be combined to create a positive impact."/><!--]--> <!--[--><link rel="canonical" href="http://sveltekit-prerender/blog/using-sqlite-triggers-to-boost-performance-of-select-count"/><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[--><!--[--><meta property="og:url" content="http://sveltekit-prerender/blog/using-sqlite-triggers-to-boost-performance-of-select-count"/><!--]--> <!--[--><meta property="og:type" content="website"/> <!--[!--><!--[!--><!--[!--><!--[!--><!--]--><!--]--><!--]--><!--]--><!--]--> <!--[--><meta property="og:title" content="Using SQLite Triggers to Boost the Performance of SELECT COUNT(*)"/><!--]--> <!--[--><meta property="og:description" content="Experienced fullstack developer, curious about how tech, systems thinking and Doughnut design for business can be combined to create a positive impact."/><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--><!----><title>Using SQLite Triggers to Boost the Performance of SELECT COUNT(*) · Samuel Plumppu - Sustainability Entrepreneur &amp; Fullstack Developer</title>
    </head>

    <body
        class="bg-honeydew dark:bg-evergreen"
        data-sveltekit-preload-data="hover"
    >
        <div id="svelte" style="display: contents"><!--[--><!--[--><!----><!----> <header class="xs:text-base 2xs:justify-between mx-auto flex max-w-6xl flex-1 flex-wrap justify-center gap-x-2 gap-y-4 p-4 text-sm svelte-12qhfyh"><a href="/" class="link"><!---->Samuel Plumppu<!----></a><!----> <nav class="xs:space-x-4 flex space-x-2"><a href="/subscribe" title="Subscribe (Atom / JSON)" class="link flex"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="size-4" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 11a9 9 0 0 1 9 9M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></g></svg><!----></a><!----> <!--[--><a href="/blog" class="link"><!---->Blog<!----></a><a href="/about" class="link"><!---->About<!----></a><a href="/talks" class="link"><!---->Talks<!----></a><!--]--> <button title="Toggle theme from dark to light" aria-label="Toggle theme from dark to light" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="size-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2S2 6.477 2 12s4.477 10 10 10m0-1.5v-17a8.5 8.5 0 0 1 0 17"></path></svg></button><!----></nav></header> <div class="container mx-auto max-w-6xl p-4 pb-0"><!----><article class="prose prose-hr:border-yellow/60 sm:prose-lg lg:prose-xl prose-blockquote:text-current prose-strong:text-current prose-blockquote:bg-white dark:prose-blockquote:bg-carbon-black prose-blockquote:py-1 prose-blockquote:rounded-md prose-headings:text-current mx-auto mt-4 max-w-[75ch] text-base text-current marker:text-current"><h1>Using SQLite Triggers to Boost the Performance of SELECT COUNT(*)</h1> <div class="flex flex-wrap gap-1 text-sm whitespace-nowrap sm:text-base"><span>Published <time datetime="2025-08-27T00:00:00.000Z">27 Aug 2025</time></span> <span><!--[--><!--[-->· Updated <time datetime="2025-12-16T22:40:59.000Z">16 Dec 2025</time><!--]--><!--]--></span></div> <!--[--><div class="xs:text-sm flex flex-wrap items-center gap-2 text-xs leading-3 sm:text-base my-4"><!--[--><span class="bg-white dark:bg-carbon-black rounded-xs p-1 sm:p-2">SQLite</span><span class="bg-white dark:bg-carbon-black rounded-xs p-1 sm:p-2">Caching</span><span class="bg-white dark:bg-carbon-black rounded-xs p-1 sm:p-2">Performance</span><!--]--></div><!--]--><!----> <!----><article><p>I recently developed a website where the landing page shows two important numbers, both derived from the <code>users</code> table. Initially, these numbers were retrieved by executing <code>SELECT COUNT(*)</code> for every page load. This worked well in the beginning but got slower as the number of users grew and the website traffic increased. However, by using SQLite triggers and a dedicated <code>stats</code> table, I made the website load much faster, and using fewer resources. This blog post describes my process and how to implement similar solutions in your own projects.</p><h2>The website requirements</h2><p>During the sign-up, users choose if they want to become members and whether they want to be visible on the website. The count of members and non-members are then visible on the landing page, only including the users who want to be visible.</p><p>Here are the two relevant boolean columns in the <code>users</code> table, represented as the integers <code>1</code> or <code>0</code> in SQLite:</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">CREATE</span><span style="color:#C678DD"> TABLE</span><span style="color:#61AFEF"> users</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">    "is_member"</span><span style="color:#C678DD"> integer</span><span style="color:#C678DD"> NOT NULL</span><span style="color:#7F848E;font-style:italic">   -- boolean: 1 or 0</span></span>
<span class="line"><span style="color:#98C379">    "is_visible"</span><span style="color:#C678DD"> integer</span><span style="color:#C678DD"> NOT NULL</span><span style="color:#7F848E;font-style:italic">  -- boolean: 1 or 0</span></span>
<span class="line"><span style="color:#ABB2BF">)</span></span>
<span class="line"></span></code></pre><!----><!----><p>To show the number of members and non-members on the landing page, I first used the following <code>SELECT COUNT(*)</code> query, only including those who want to be visible:</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">SELECT</span></span>
<span class="line"><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C678DD">    SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">        "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#C678DD">        AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">    )</span></span>
<span class="line"><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#98C379"> "members"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C678DD">    SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">        "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">        AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">    )</span></span>
<span class="line"><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#98C379"> "non_members"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span></code></pre><!----><!----><p>This worked well initially, but it gradually slowed down as the <code>users</code> table grew and the website got more traffic. The reason why <code>SELECT COUNT(*)</code> is slower for larger tables is because SQlite needs to scan the table and check every row, which takes longer time for larger tables with many rows. <code>SELECT COUNT(*)</code> is essentially an <code>O(n)</code> operation in terms of time complexity, and since we did two queries for every visit to the landing page, the total time complexity is more like <code>2 * O(n)</code>.</p><h2>Why SQLite indexes are not suitable for boolean columns</h2><p>To improve query performance, I first thought about using a DB index and started experimenting. In some cases, this made the <code>SELECT COUNT(*)</code> queries faster. However, there were also other cases that actually resulted in worse performance than just letting SQLite do full table scans for each <code>SELECT COUNT(*)</code> query.</p><p>The reason for this is that indexes are better suited for columns that have many different values, such as strings. Since we have two boolean columns which only can have the values <code>1</code> or <code>0</code>, we don't get reliable benefits from using an index.</p><p>This made me take a step back to think more about the problem I wanted to solve: To avoid counting members and non-members on every page load.</p><h2>Exploring various caching options</h2><p>What if we could somehow cache the latest counts and retrieve them when they were needed? This could be solved with many different kinds of caching. On one hand, in-memory caching could be an alternative, but would not be reliable since the website backend runs in many different instances which means we could end up showing different results depending on which instance that served incoming requests. On the other hand, a dedicated cache implemented with for example <a href="https://valkey.io/" class="link"><!---->Valkey<!----></a><!----> would introduce another component to the backend system only to cache two numbers, which would not be worth the increased maintenance required. I like to keep the tech stack as simple as possible and neither of these solutions were appropriate for this specific problem.</p><p>Since we have plenty of capacity in the SQLite database for both more read- and write operations, what if we could cache the latest counts directly in SQLite?</p><p>I looked for inspiration and realized this would be a good opportunity to explore SQLite triggers, which seemed useful to solve my problem. Using SQLite triggers, we could re-evaluate the <code>SELECT COUNT(*)</code> only when there are meaningful changes in the DB, and save the counts in a separate <code>stats</code> table that can easily be looked up when needed.</p><h2>A brief intro to SQLite triggers</h2><p><a href="https://www.sqlite.org/lang_createtrigger.html" class="link"><!---->SQLite triggers<!----></a><!----> can be used to execute SQL statements when certain events happen in the database. These events can be for example <code>BEFORE INSERT</code> to validate data before saving it, or <code>AFTER UPDATE</code> to react when some table is updated. The basic syntax looks like this:</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">CREATE</span><span style="color:#C678DD"> TRIGGER</span><span style="color:#61AFEF"> trigger_name</span></span>
<span class="line"><span style="color:#E06C75">[BEFORE | AFTER]</span><span style="color:#E06C75"> [INSERT | UPDATE | DELETE]</span></span>
<span class="line"><span style="color:#C678DD">ON</span><span style="color:#ABB2BF"> table_name</span></span>
<span class="line"><span style="color:#C678DD">BEGIN</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   -- SQL statements to run here</span></span>
<span class="line"><span style="color:#C678DD">END</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span></code></pre><!----><!----><p>SQLite triggers are very flexible and powerful. Notably, they can also use references to the <code>NEW</code> and <code>OLD</code> rows to know which rows and columns that changed, and how.</p><p>However, triggers should be tested carefully, since their execution can block other DB operations. Changing triggers requires deploying a new DB migration, where the faulty triggers are dropped, and then re-created with updated SQL statements that should be executed. It's doable, but could cause consequences in a production environment. Therefore, it's important to test properly before deploying triggers.</p><h2>The solution: Using SQLite triggers to cache stats</h2><p>With this knowledge, I started experimenting by executing SQL statements in a shell. First creating the <code>stats</code> table and inserting the initial state based on the current <code>users</code> table. Then adding triggers that updated the <code>stats</code> whenever the <code>users</code> table had meaningful changes. And finally, verifying that the triggers behaved as expected and correctly updated the <code>stats</code> when I inserted, updated and deleted users.</p><p>Once I had working triggers, I combined the SQL statements into the following DB migration:</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">CREATE</span><span style="color:#C678DD"> TABLE</span><span style="color:#ABB2BF"> `</span><span style="color:#61AFEF">stats</span><span style="color:#ABB2BF">` (</span></span>
<span class="line"><span style="color:#98C379">	`id`</span><span style="color:#C678DD"> integer</span><span style="color:#C678DD"> PRIMARY KEY</span><span style="color:#ABB2BF"> AUTOINCREMENT </span><span style="color:#C678DD">NOT NULL</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">	`members`</span><span style="color:#C678DD"> integer</span><span style="color:#C678DD"> NOT NULL</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#98C379">	`non_members`</span><span style="color:#C678DD"> integer</span><span style="color:#C678DD"> NOT NULL</span></span>
<span class="line"><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- For all stats calculations, we only include users</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- who want to be visible --> where is_visible = 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- During the migration when the stats table is created,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- we need to add the initial stats based on the current DB state.</span></span>
<span class="line"><span style="color:#C678DD">INSERT INTO</span><span style="color:#98C379"> "stats"</span><span style="color:#ABB2BF"> (</span><span style="color:#98C379">"members"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"non_members"</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">SELECT</span></span>
<span class="line"><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C678DD">    SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">        "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#C678DD">        AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">    )</span></span>
<span class="line"><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#98C379"> "members"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C678DD">    SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">        "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">        AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">    )</span></span>
<span class="line"><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#98C379"> "non_members"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- Update stats when a new user was added</span></span>
<span class="line"><span style="color:#C678DD">CREATE</span><span style="color:#C678DD"> TRIGGER</span><span style="color:#61AFEF"> trigger_update_stats_after_insert</span></span>
<span class="line"><span style="color:#C678DD">AFTER</span><span style="color:#C678DD"> INSERT</span></span>
<span class="line"><span style="color:#C678DD">ON</span><span style="color:#98C379"> "users"</span></span>
<span class="line"><span style="color:#C678DD">BEGIN</span></span>
<span class="line"><span style="color:#C678DD">    UPDATE</span><span style="color:#98C379"> "stats"</span></span>
<span class="line"><span style="color:#C678DD">    SET</span><span style="color:#98C379"> "members"</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#C678DD">        SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">                "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#C678DD">                AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">            )</span></span>
<span class="line"><span style="color:#ABB2BF">        ),</span></span>
<span class="line"><span style="color:#98C379">        "non_members"</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#C678DD">            SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">                "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">                AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">            )</span></span>
<span class="line"><span style="color:#ABB2BF">        )</span></span>
<span class="line"><span style="color:#C678DD">    WHERE</span><span style="color:#ABB2BF"> id </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">END</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- Update stats when a user was updated</span></span>
<span class="line"><span style="color:#C678DD">CREATE</span><span style="color:#C678DD"> TRIGGER</span><span style="color:#61AFEF"> trigger_update_stats_after_update</span></span>
<span class="line"><span style="color:#C678DD">AFTER</span><span style="color:#C678DD"> UPDATE</span></span>
<span class="line"><span style="color:#C678DD">ON</span><span style="color:#98C379"> "users"</span></span>
<span class="line"><span style="color:#C678DD">BEGIN</span></span>
<span class="line"><span style="color:#C678DD">    UPDATE</span><span style="color:#98C379"> "stats"</span></span>
<span class="line"><span style="color:#C678DD">    SET</span><span style="color:#98C379"> "members"</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#C678DD">        SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">                "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#C678DD">                AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">            )</span></span>
<span class="line"><span style="color:#ABB2BF">        ),</span></span>
<span class="line"><span style="color:#98C379">        "non_members"</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#C678DD">            SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">                "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">                AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">            )</span></span>
<span class="line"><span style="color:#ABB2BF">        )</span></span>
<span class="line"><span style="color:#C678DD">    WHERE</span><span style="color:#ABB2BF"> id </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">END</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">-- Update stats when a user was deleted</span></span>
<span class="line"><span style="color:#C678DD">CREATE</span><span style="color:#C678DD"> TRIGGER</span><span style="color:#61AFEF"> trigger_update_stats_after_delete</span></span>
<span class="line"><span style="color:#C678DD">AFTER</span><span style="color:#C678DD"> DELETE</span></span>
<span class="line"><span style="color:#C678DD">ON</span><span style="color:#98C379"> "users"</span></span>
<span class="line"><span style="color:#C678DD">BEGIN</span></span>
<span class="line"><span style="color:#C678DD">    UPDATE</span><span style="color:#98C379"> "stats"</span></span>
<span class="line"><span style="color:#C678DD">    SET</span><span style="color:#98C379"> "members"</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#C678DD">        SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">                "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#C678DD">                AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">            )</span></span>
<span class="line"><span style="color:#ABB2BF">        ),</span></span>
<span class="line"><span style="color:#98C379">        "non_members"</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#C678DD">            SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">                "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">                AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">            )</span></span>
<span class="line"><span style="color:#ABB2BF">        )</span></span>
<span class="line"><span style="color:#C678DD">    WHERE</span><span style="color:#ABB2BF"> id </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">END</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span></code></pre><!----><!----><p>After applying the migration above, the landing page query could be updated to read the latest <code>stats</code> instead of re-evaluating the member count for every incoming request:</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">SELECT</span><span style="color:#98C379"> "members"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"non_members"</span><span style="color:#C678DD"> FROM</span><span style="color:#98C379"> "stats"</span><span style="color:#C678DD"> WHERE</span><span style="color:#98C379"> "stats"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"id"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"></span></code></pre><!----><!----><p>Note that I always use <code>id = 1</code> to read and update stats. This could potentially break in the future since the <code>id</code> is theoretically not guaranteed to always be <code>1</code>.</p><p>I still went with this solution though, because the first row is created in the migration above, no other code except the triggers are updating the <code>stats</code> table, and no additional rows are inserted either in the database or in the application code. Selecting an explicit <code>id</code> offered better performance compared to using <code>LIMIT 1</code>.</p><p>While it might not be ideal to save state like this that could easily get out of date, potential future problems could be fixed since I intentionally kept the SQLite triggers and the <code>stats</code> table as simple as possible.</p><h2>Impact and performance improvements</h2><p>The result of these changes turned out way better than expected. The read operations now take a constant time <code>O(1)</code> even after the database more than doubled in size. Best of all, this problem could be solved without introducing another dependency only needed to cache two numbers. Simple and effective solutions are key to making technology easier to understand, maintain and improve.</p><p>Let's explore how and why the performance improved:</p><h3>Before</h3><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">SELECT</span></span>
<span class="line"><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C678DD">    SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">        "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#C678DD">        AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">    )</span></span>
<span class="line"><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#98C379"> "members"</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#ABB2BF">(</span></span>
<span class="line"><span style="color:#C678DD">    SELECT</span><span style="color:#56B6C2"> COUNT</span><span style="color:#ABB2BF">(*) </span><span style="color:#C678DD">FROM</span><span style="color:#98C379"> "users"</span><span style="color:#C678DD"> WHERE</span><span style="color:#ABB2BF"> (</span></span>
<span class="line"><span style="color:#98C379">        "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_member"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 0</span></span>
<span class="line"><span style="color:#C678DD">        AND</span><span style="color:#98C379"> "users"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"is_visible"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"><span style="color:#ABB2BF">    )</span></span>
<span class="line"><span style="color:#ABB2BF">) </span><span style="color:#C678DD">as</span><span style="color:#98C379"> "non_members"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span></code></pre><!----><!----><p>Even though it didn't take more than <code>2 * 22 ms = 44 ms</code> to run the two <code>SELECT COUNT(*)</code> queries for every page load, the query time was growing significantly and could get out of hand as we got more users.</p><p>Another issue with this query was that it caused two full table scans, reading all rows from the users table twice and using unnecessary resources. In some cloud-hosted databases where you pay per usage, excess row reads could be a limiting and potentially costly problem.</p><h3>After</h3><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">SELECT</span><span style="color:#98C379"> "members"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"non_members"</span><span style="color:#C678DD"> FROM</span><span style="color:#98C379"> "stats"</span><span style="color:#C678DD"> WHERE</span><span style="color:#98C379"> "stats"</span><span style="color:#ABB2BF">.</span><span style="color:#98C379">"id"</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> 1</span></span>
<span class="line"></span></code></pre><!----><!----><p>The new query only reads one row and its execution time stays constant at <code>27 ms</code>, even as the database more than doubled in size. This might not seem like much of an improvement in the beginning, but compared to the previous solution, the difference will only get bigger as the database grows. It didn't take many days before it was way faster compared to running two <code>SELECT COUNT(*)</code> operations for landing page visit. With a much more predictable query time, this approach will continue to perform over time.</p><p>I'm curious to understand why it needs <code>27 ms</code> for what seems like a very simple read operation. Please let me know if you know a way to make this even faster.</p><h2>Conclusion: When to use SQLite triggers</h2><p>Like any solution, this one has two trade-offs worth mentioning:</p><ol><li>Every <code>INSERT</code>, <code>UPDATE</code> and/or <code>DELETE</code> will take slightly longer to complete because it also executes the corresponding SQLite trigger. In our case, this is acceptable since this part of the project needs to optimize for fast reads on the landing page. However, if your system needs to optimize for fast writes, this might be a problem.</li><li>We need to store an additional <code>stats</code> table in the DB, which might get outdated if something happens with the triggers or the tables used to calculate the <code>stats</code>. However, the table is only one row and is only modified by triggers and never from application code. Thus, SQLite triggers are a good tool as long as you test them properly.</li></ol><p>In our case, these are very good trade-offs to make the website load significantly faster - and stay fast over time.</p><p>Even though SQLite triggers worked well in this case, I would carefully consider other options before implementing SQLite triggers in other projects. For simple use cases, it might be worth it, but for more complex business logic for data validations and transformations, consider implementing them as part of your regular backend code instead.</p><p>In cases where more complex validations and transformations are needed, keeping one backend module responsible for a part of the database and giving that module exclusive responsibilities to write to and read from that part of the database, you can achieve the same result as with SQLite triggers, while also making integration testing much easier. SQLite triggers are possible to test, but harder to debug if you make errors, and thus it seems reasonable to mostly use them for simpler cases.</p><h2>Bonus: When to optimize performance</h2><p>This kind of work should usually happen after the main functionality is implemented, deployed and confirmed to be valuable with users and stakeholders. Only then could it be a good time to start optimizing a system by identifying potential bottlenecks and deciding when and how you need to deal with them. Even if you don't implement performance optimizations immediately, making a note about potential issues will make them easier to identify and fix when (or rather, if) the need arises in the future.</p><p>Just don't optimize too early. Instead, focus on the core value first and improve with each iteration.</p></article><!----></article> <section class="dark:bg-carbon-black mx-auto mt-12 max-w-lg space-y-4 rounded-md bg-white p-4 text-center shadow-lg lg:text-lg"><h2 class="xs:text-2xl text-xl leading-none font-black tracking-tight md:text-3xl">Thank you for reading!</h2> <p><a href="https://fosstodon.org/@Greenheart" class="link compact"><!---->Let me know<!----></a><!----> if you have any questions
        or comments.</p> <p><span class="inline-flex flex-wrap items-center justify-center gap-1"><a href="/subscribe" class="link inline-flex items-center gap-1 compact"><img src="/images/feed.svg" alt="RSS/Atom feed icon" class="size-5"/>Subscribe<!----></a><!----> with your feed reader: <span class="inline-flex flex-nowrap items-center gap-0.5"><a href="/feed.atom" class="link self-center compact"><!---->Atom<!----></a><!---->/<a href="/feed.json" class="link self-center compact"><!---->JSON<!----></a><!----></span></span></p><!----> <p><a href="/blog" class="link compact"><!---->Read 15 more posts<!----></a><!----> or <a href="/" class="link compact"><!---->learn more<!----></a><!----> about me.</p></section> <nav class="mx-auto grid max-w-5xl gap-8 pt-8 sm:grid-cols-2 sm:gap-4 lg:gap-8"><!--[--><a href="/blog/install-playwright-on-linux-with-distrobox" class="dark:bg-carbon-black group flex flex-col gap-4 rounded-md bg-white p-4 shadow-md transition-all duration-300 hover:shadow-xl"><span class="flex items-center gap-2 text-xs font-bold tracking-wide uppercase"><svg viewBox="0 0 24 24" width="1.2em" height="1.2em" class="size-5 shrink-0"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m15 18l-6-6l6-6"></path></svg><!----> Previous</span> <span class="group-hover:decoration-moss underline-offset-3 group-hover:underline">Installing Playwright on non-Ubuntu Linux distributions</span></a><!--]--> <!--[--><a href="/blog/automated-text-extraction-from-pdf-images-with-ocrmypdf" class="dark:bg-carbon-black group flex flex-col items-end gap-4 rounded-md bg-white p-4 text-end shadow-md transition-all duration-300 hover:shadow-xl"><span class="flex items-center gap-2 text-xs font-bold tracking-wide uppercase">Next <svg viewBox="0 0 24 24" width="1.2em" height="1.2em" class="size-5 shrink-0"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 18l6-6l-6-6"></path></svg><!----></span> <span class="group-hover:decoration-moss underline-offset-3 group-hover:underline">Automated Text Extraction from PDF Images with OCRmyPDF</span></a><!--]--></nav><!----><!----><!----></div> <footer class="container mx-auto max-w-6xl px-4 pb-8 text-center"><hr class="border-yellow mx-auto my-16 max-w-sm" id="contact"/> <h2 class="xs:text-2xl mb-6 text-xl leading-none font-black tracking-tight text-balance sm:text-3xl lg:text-4xl">Let's co-create a sustainable future!</h2> <a href="#" class="bg-moss inline-flex transform-gpu justify-center justify-self-center rounded-md px-8 py-3 font-black text-black shadow-lg duration-150 ease-out hover:scale-105 hover:shadow-xl "><span class="whitespace-nowrap">Email me</span></a><!----> <p class="mt-8">© 2015 - 2026 Samuel Plumppu</p> <div class="flex flex-wrap items-center justify-center space-x-8 dark:invert my-8"><a href="https://matrix.to/#/@Greenheart:matrix.org" target="_blank" rel="noopener noreferrer" aria-label="Message me securely with the Matrix protocol"><img src="/images/matrix-logo.svg" alt="Matrix.org logo" class="h-6"/></a> <a href="https://github.com/Greenheart" target="_blank" rel="noopener noreferrer" aria-label="See my libre software at GitHub"><img src="/images/github.svg" alt="GitHub" class="aspect-square h-6"/></a> <a href="https://fosstodon.org/@Greenheart" target="_blank" rel="me noopener noreferrer" aria-label="Follow me on Mastodon"><img src="/images/mastodon-logo.svg" alt="Mastodon" class="aspect-square h-6"/></a> <a href="https://linkedin.com/in/samuelplumppu" target="_blank" rel="noopener noreferrer" aria-label="Connect with me on LinkedIn"><img src="/images/linkedin.svg" alt="LinkedIn" class="aspect-square h-6"/></a></div><!----> <p><span class="inline-flex flex-wrap items-center justify-center gap-1"><a href="/subscribe" class="link inline-flex items-center gap-1 compact"><img src="/images/feed.svg" alt="RSS/Atom feed icon" class="size-5"/>Subscribe<!----></a><!----> with your feed reader: <span class="inline-flex flex-nowrap items-center gap-0.5"><a href="/feed.atom" class="link self-center compact"><!---->Atom<!----></a><!---->/<a href="/feed.json" class="link self-center compact"><!---->JSON<!----></a><!----></span></span></p><!----></footer><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_cp428i = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.VKf-84Bf.js"),
						import("../_app/immutable/entry/app.Dtaxfko_.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
    </body>
</html>
