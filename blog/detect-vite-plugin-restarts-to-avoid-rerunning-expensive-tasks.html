<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/images/favicon.svg" type="image/svg+xml" />
        <link rel="icon" href="/images/favicon-32x32.png" type="image/png" />
        <link rel="icon" href="/favicon.ico" />
        <meta name="theme-color" content="#5ac75f" />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/images/compass-icon-square.svg"
        />
        
		<link href="../_app/immutable/assets/0.Ct9HJVJb.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.BE60H6Gy.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/dDqySKTV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DaAUV8UA.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B2YQBVX4.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BvmBbEGu.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C7rtondD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D0iwhpLH.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.CvpyGbbR.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/PPVm8Dsz.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DsnmJJEf.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C6yErPMg.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/wTsZxNd-.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CGu1RveD.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.BKx57qsc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/qMC3yWpg.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Czz5jtNV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/XnrzCMR9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/HzuPKAlg.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/9U1LMgEo.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Ctur7ITO.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/5.D0nlw7dq.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BQfiLhQe.js"><!--[--><!--[--><!--]--> <!--[--><meta name="robots" content="index,follow"/><!--]--> <!--[--><meta name="description" content="Experienced fullstack developer, curious about how tech, systems thinking and Doughnut design for business can be combined to create a positive impact."/><!--]--> <!--[--><link rel="canonical" href="http://sveltekit-prerender/blog/detect-vite-plugin-restarts-to-avoid-rerunning-expensive-tasks"/><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[--><!--[--><meta property="og:url" content="http://sveltekit-prerender/blog/detect-vite-plugin-restarts-to-avoid-rerunning-expensive-tasks"/><!--]--> <!--[--><meta property="og:type" content="website"/> <!--[!--><!--[!--><!--[!--><!--[!--><!--]--><!--]--><!--]--><!--]--><!--]--> <!--[--><meta property="og:title" content="Detect Vite Plugin Restarts to Avoid Rerunning Expensive Tasks"/><!--]--> <!--[--><meta property="og:description" content="Experienced fullstack developer, curious about how tech, systems thinking and Doughnut design for business can be combined to create a positive impact."/><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--><!--]--> <!--[!--><!--]--> <!--[!--><!--]--><!--]--><title>Detect Vite Plugin Restarts to Avoid Rerunning Expensive Tasks Â· Samuel Plumppu - Sustainability Entrepreneur &amp; Fullstack Developer</title>
    </head>

    <body class="bg-honeydew" data-sveltekit-preload-data="hover">
        <div id="svelte" style="display: contents"><!--[--><!--[--><!--[--><!----><!--[!--><!----> <header class="mx-auto flex max-w-6xl flex-1 flex-wrap justify-between gap-x-2 gap-y-4 p-4 svelte-12qhfyh"><a href="/" class="link"><!---->Samuel Plumppu<!----></a><!----> <nav class="xs:space-x-4 flex space-x-2"><!--[--><a href="/blog" class="link"><!---->Blog<!----></a><a href="/about" class="link"><!---->About<!----></a><a href="/talks" class="link"><!---->Talks<!----></a><!--]--></nav></header> <div class="container mx-auto max-w-6xl p-4 pb-0"><!----><article class="prose prose-hr:border-ming sm:prose-lg lg:prose-xl prose-blockquote:text-black prose-strong:text-black prose-blockquote:bg-white prose-blockquote:py-1 prose-blockquote:rounded-md prose-headings:text-black mx-auto mt-4 max-w-[75ch] text-base text-black marker:text-black"><h1>Detect Vite Plugin Restarts to Avoid Rerunning Expensive Tasks</h1> <time datetime="2025-09-18T00:00:00.000Z">18 September 2025</time> <!--[--><div class="xs:text-sm flex flex-wrap items-center gap-2 text-xs leading-3 sm:text-base my-4"><!--[--><span class="bg-mantis rounded-xs p-1 sm:p-2">Node.js</span><span class="bg-mantis rounded-xs p-1 sm:p-2">TypeScript</span><span class="bg-mantis rounded-xs p-1 sm:p-2">Vite</span><!--]--></div><!--]--><!----> <!----><article><p>When developing <a href="https://vite.dev" class="link"><!---->Vite<!----></a><!----> plugins, you sometimes need to detect when the Vite server restarts. Both the <code>vite</code> dev server and <code>vite build</code> can run your plugin multiple times within the same Node.js process. In my case, I wanted to only execute an expensive task once, and avoid duplicate work.</p><p>It's usually convenient to let Vite restart the dev server whenever the configuration or other imported modules change, and rerunning your Vite plugins. However, this also means that expensive setup work could happen multiple times, wasting both time and resources. This is especially important if your plugin does expensive computations which could slow down the development experience, and if your production build involves a prerendering step, like <a href="https://svelte.dev/docs/kit/introduction" class="link"><!---->SvelteKit<!----></a><!---->.</p><p>To make a Vite plugin only execute some task on the first run, we can take advantage of the fact that Vite (I'm using version 7.1.5 at the time of writing) runs the dev server as well as the production build within the same Node.js process. This means we can define properties on <code>globalThis</code> to communicate between different executions of the vite plugin.</p><p>While I generally think global state like <code>globalThis</code> should be avoided as much as possible, this seems like a good time to use it. Here is a minimal example of how you can use this technique in your Vite plugin:</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic">// Add type safety</span></span>
<span class="line"><span style="color:#C678DD">declare</span><span style="color:#E06C75"> global</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /** Ensure the Vite plugin only runs some expensive task once */</span></span>
<span class="line"><span style="color:#C678DD">    var</span><span style="color:#E5C07B"> HAS_RUN_BEFORE</span><span style="color:#ABB2BF">: </span><span style="color:#E5C07B">boolean</span><span style="color:#ABB2BF"> | </span><span style="color:#E5C07B">undefined</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">function</span><span style="color:#61AFEF"> yourVitePlugin</span><span style="color:#ABB2BF">() {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Logs `undefined` the first time and then `true`.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Use `process.uptime()` to easily identify whenever Vite reruns your plugin.</span></span>
<span class="line"><span style="color:#E5C07B">    console</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">log</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">globalThis</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">HAS_RUN_BEFORE</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">process</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">uptime</span><span style="color:#ABB2BF">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">globalThis</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">HAS_RUN_BEFORE</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#61AFEF">        runExpensiveTask</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#E5C07B">        globalThis</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">HAS_RUN_BEFORE</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    console</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">log</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">globalThis</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">HAS_RUN_BEFORE</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">process</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">uptime</span><span style="color:#ABB2BF">()) </span><span style="color:#7F848E;font-style:italic">// Always logs `true`.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // (...)</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre><!----><!----><h2>A real-world example</h2><p>I'm building a Vite plugin specifically to integrate with the SvelteKit production build and prerendering, where the Vite server first creates the production build, which is then prerendered by SvelteKit in a separate restart.</p><p>In the following example, <code>globalThis.HAS_CMS_BUILD_STARTED</code> is only assigned once, and can then be read by all future instances of the Vite plugin to prevent the build from running more than once. Without the <code>globalThis</code> workaround, this would have meant the expensive build logic would be run two times, or even more for development server restarts.</p><!----><pre class="shiki one-dark-pro" style="background-color:#282c34;color:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#C678DD">import</span><span style="color:#C678DD"> type</span><span style="color:#ABB2BF"> { </span><span style="color:#E06C75">ConfigEnv</span><span style="color:#ABB2BF"> } </span><span style="color:#C678DD">from</span><span style="color:#98C379"> 'vite'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">declare</span><span style="color:#E06C75"> global</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /** Ensure the CMS is only built at most once for each execution of `vite` */</span></span>
<span class="line"><span style="color:#C678DD">    var</span><span style="color:#E5C07B"> HAS_CMS_BUILD_STARTED</span><span style="color:#ABB2BF">: </span><span style="color:#E5C07B">boolean</span><span style="color:#ABB2BF"> | </span><span style="color:#E5C07B">undefined</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">type</span><span style="color:#E5C07B"> BuildMode</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> 'prio'</span><span style="color:#ABB2BF"> | </span><span style="color:#E5C07B">boolean</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">/**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * Only (re)build the CMS when it makes sense. This is a simple way to save</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * resources during development, while building for the actual production build,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> * but not when serving.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic"> */</span></span>
<span class="line"><span style="color:#C678DD">function</span><span style="color:#61AFEF"> getBuildMode</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">env</span><span style="color:#ABB2BF">: </span><span style="color:#E5C07B">ConfigEnv</span><span style="color:#ABB2BF">): </span><span style="color:#E5C07B">BuildMode</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Avoid duplicate builds in the same execution of the `vite` command.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // We only need to rebuild the CMS when dependencies have changed,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // and a simple solution is to build the CMS the first time the Vite</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // dev server or production build starts.</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">globalThis</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">HAS_CMS_BUILD_STARTED</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> false</span></span>
<span class="line"><span style="color:#ABB2BF">    } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // We can use `globalThis` to reliably determine if there has been</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // a previous build. This is possible since `globalThis` is shared</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // in the Vite parent process that restarts the build, and because</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // both the Vite config loading and the SvelteKit dev/build process</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // are run by the same parent process.</span></span>
<span class="line"><span style="color:#E5C07B">        globalThis</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">HAS_CMS_BUILD_STARTED</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> true</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">env</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">mode</span><span style="color:#56B6C2"> !==</span><span style="color:#98C379"> 'development'</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">env</span><span style="color:#ABB2BF">.</span><span style="color:#E06C75">command</span><span style="color:#56B6C2"> ===</span><span style="color:#98C379"> 'build'</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // In production builds, we want to finish the CMS build before</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // other parts of the app. This makes sure the CMS build finishes</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // before other parts of the build.</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#98C379"> 'prio'</span></span>
<span class="line"><span style="color:#ABB2BF">        } </span><span style="color:#C678DD">else</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // Don't build when serving in production.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // In these cases the CMS should already be built.</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#D19A66"> false</span></span>
<span class="line"><span style="color:#ABB2BF">        }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // Build the first time during development</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> true</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre><!----><!----></article><!----></article> <section class="mx-auto mt-12 max-w-lg rounded-md bg-white p-4 text-center shadow-lg"><h2 class="xs:text-2xl mb-4 text-xl leading-none font-black tracking-tight md:text-3xl">Thank you for reading! ð±</h2> <p class="mb-4 lg:text-lg"><a href="https://fosstodon.org/@Greenheart" class="link compact"><!---->Let me know<!----></a><!----> if you have any questions
        or comments.</p> <p class="lg:text-lg"><a href="/blog" class="link compact"><!---->Read 12 more posts<!----></a><!----> or <a href="/" class="link compact"><!---->learn more<!----></a><!----> about me.</p></section> <nav class="mx-auto grid max-w-5xl gap-8 pt-8 sm:grid-cols-2 sm:gap-4 lg:gap-8"><!--[--><a href="/blog/automated-text-extraction-from-pdf-images-with-ocrmypdf" class="group flex flex-col gap-4 rounded-md bg-amber-100 p-4 shadow-md transition-all duration-300 hover:bg-amber-400/60 hover:shadow-xl"><span class="flex items-center gap-2 text-xs font-bold tracking-wide uppercase"><svg viewBox="0 0 24 24" width="1.2em" height="1.2em" class="size-5 shrink-0"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m15 18l-6-6l6-6"></path></svg><!----> Previous</span> <span class="underline-offset-3 group-hover:underline">Automated Text Extraction from PDF Images with OCRmyPDF</span></a><!--]--> <!--[!--><div class="hidden sm:block"></div><!--]--></nav><!----><!----><!----></div> <footer class="container mx-auto max-w-6xl px-4 pb-4 text-center font-light"><hr class="border-ming mx-auto my-16 max-w-sm" id="contact"/> <h2 class="xs:text-2xl mb-6 text-xl leading-none font-black tracking-tight text-balance sm:text-3xl lg:text-4xl">Let's co-create a sustainable future!</h2>  <a href="#" class="bg-mantis inline-flex transform-gpu justify-center justify-self-center rounded-md px-8 py-3 font-black text-black shadow-lg duration-150 hover:scale-105 hover:shadow-xl "><span class="whitespace-nowrap">Email me</span></a><!----> <p class="mt-8">Â© 2015 - 2025 Samuel Plumppu</p> <div class="my-8 flex flex-wrap items-center justify-center space-x-8"><a href="https://matrix.to/#/@Greenheart:matrix.org" target="_blank" rel="noopener noreferrer" aria-label="Message me securely with the Matrix protocol"><img src="/images/matrix-logo.svg" alt="Matrix.org logo" class="h-8"/></a> <a href="https://github.com/Greenheart" target="_blank" rel="noopener noreferrer" aria-label="See my libre software at GitHub"><img src="/images/github.svg" alt="GitHub" class="size-8"/></a> <a href="https://fosstodon.org/@Greenheart" target="_blank" rel="me noopener noreferrer" aria-label="Follow me on Mastodon"><img src="/images/mastodon-logo.svg" alt="Mastodon" class="size-8"/></a> <a href="https://linkedin.com/in/samuelplumppu" target="_blank" rel="noopener noreferrer" aria-label="Connect with me on LinkedIn"><img src="/images/linkedin.svg" alt="LinkedIn" class="size-8"/></a></div></footer><!----><!--]--><!----><!--]--> <!--[!--><!--]--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_ajdgno = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.BE60H6Gy.js"),
						import("../_app/immutable/entry/app.CvpyGbbR.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
    </body>
</html>
